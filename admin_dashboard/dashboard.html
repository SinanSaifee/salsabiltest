<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Dashboard</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name="robots" content="noindex">
    
    <!----tittle favicon icon -->

     <!-- Add this inside the <head> tag -->
<audio id="notificationSound">
    <source src="audio/notification.mp3" type="audio/mp3">
    Your browser does not support the audio tag.
  </audio>
  
  <!-- Bootstrap CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel='stylesheet' type='text/css' media='screen' href='css/adminStyle.css'>
    <link rel="shortcut icon" type="image/x-icon" href="image/sample tittle logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* =============== Navigation ================ */
    
        * {
    font-family: "Ubuntu", sans-serif;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    }
    
        :root {
    --blue: #2a2185;
    --white: #fff;
    --gray: #f5f5f5;
    --black1: #222;
    --black2: #999;
    }
    .navigation {
    position: fixed;
    width: 300px;
    height: 100%;
    background: var(--blue);
    border-left: 10px solid var(--blue);
    transition: 0.5s;
    overflow: hidden;
    top: 0;
    z-index: 9999;
    }
    .navigation.active {
    width: 80px;
    }
    
    .navigation ul {
    position: absolute;
    top: 50px;
    left: 0;
    width: 100%;
    }
    
    .navigation ul li {
    position: relative;
    width: 100%;
    list-style: none;
    border-top-left-radius: 30px;
    border-bottom-left-radius: 30px;
    }
    
    /* .navigation ul li:hover,
    .navigation ul li.hovered {
    background-color: var(--white);
    } */
    
    .navigation ul li:nth-child(1) {
    margin-bottom: 40px;
    pointer-events: none;
    }
    
    .navigation ul li a {
    position: relative;
    display: block;
    width: 100%;
    display: flex;
    text-decoration: none;
    color: var(--white);
    }
    /* .navigation ul li:hover a,
    .navigation ul li.hovered a {
    color: var(--blue);
    } */
    
    .navigation ul li a .icon {
    position: relative;
    display: block;
    min-width: 60px;
    height: 60px;
    line-height: 75px;
    text-align: center;
    }
    .navigation ul li a .icon i {
    font-size: 1.75rem;
    }
    
    .navigation ul li a .title {
    position: relative;
    display: block;
    padding: 0 10px;
    height: 60px;
    line-height: 60px;
    text-align: start;
    white-space: nowrap;
    }
    
    /* --------- curve outside ----------
    .navigation ul li:hover a::before,
    .navigation ul li.hovered a::before {
    content: "";
    position: absolute;
    right: 0;
    top: -50px;
    width: 50px;
    height: 50px;
    background-color: transparent;
    border-radius: 50%;
    box-shadow: 35px 35px 0 10px var(--white);
    pointer-events: none;
    }
    .navigation ul li:hover a::after,
    .navigation ul li.hovered a::after {
    content: "";
    position: absolute;
    right: 0;
    bottom: -50px;
    width: 50px;
    height: 50px;
    background-color: transparent;
    border-radius: 50%;
    box-shadow: 35px -35px 0 10px var(--white);
    pointer-events: none;
    } */

    #toggleButton{
        border: none;
        position: fixed;  
        top: 14px;
        left: 25px;
        z-index: 99999;
        background: none;
    }
    #toggleButton i{
        color: #fff;   
        cursor: pointer; 
    }
    .active-page{
    background: #fff;
    border-top-left-radius: 30px;
    border-bottom-left-radius: 30px;
    color: var(--blue);
    }
    .active-page a span{
        color: var(--blue);
    }
    .active-page::before{
        content: "";
    position: absolute;
    right: 0;
    top: -50px;
    width: 50px;
    height: 50px;
    background-color: transparent;
    border-radius: 50%;
    box-shadow: 35px 35px 0 10px var(--white);
    pointer-events: none; 
    }
    .active-page::after{
        content: "";
    position: absolute;
    right: 0;
    bottom: -50px;
    width: 50px;
    height: 50px;
    background-color: transparent;
    border-radius: 50%;
    box-shadow: 35px -35px 0 10px var(--white);
    pointer-events: none;
    }
  


.notification-date-container {
    margin-top: 10px;
}

.notification-divider {
    color: #ccc;
    font-size: 14px;
}
#topCustomersContainer{
    max-height: 100px;
    overflow: scroll;
    overflow-x: hidden;
}
#topProductsContainer{
    max-height: 100px;
    overflow: scroll;
    overflow-x: hidden;
    
}
.statictics-container{
    margin-bottom: 20px;
    display: flex;
    
}
#qrCodeContainer{
    position: absolute;
    margin-top: -450px;
    right: 200px;
}
#invoice-generator-btn{
    background: #000;
    color: #fff;
    float: right;
    padding: 10px 15px;
    border-radius: 50%;
}
#invoice-generator-btn i{
    font-size: 27px;
}
@media(max-width: 1020px){  
    .navigation{
        display: none;
    }
    #toggleButton i{
        color: #222;
    }
    #toggleButton{
        position: relative;
    }
    .order-container{
        margin-left: 20px;
        width: 100%;
        max-width: 100%;
        padding: 10px;
        right: 20px;
        justify-content: flex-start;
    }
    
    .statictics-container{
        display: flex;
        flex-direction: column;
        width: 100%;
        
    }
    .statictics-container .container{
        width: 100%;
        max-width: 100%;
        min-width: 100%;
        
    }
    .button-container{
        flex-direction: column;
    }
    
    

}
.display-navigation{
    display: block;
}



 
    </style>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

</head>

<body id="body">
    <button id="toggleButton">
        <i class="fas fa-bars fa-2x"></i>
    </button>

    <!-- Loading gif -->
    <div id="loading">
        <img src="loading copy.gif" alt="Loading" width="50" height="50">
        <p>Signing out</p>
    </div>
     <!-- =============== Navigation ================ -->
        <div class="navigation">
            
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-user-tie"></i>
                        </span>
                        <span class="title">ADMIN</span>
                    </a>
                </li>

                <li class="active-page" >
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-cart-shopping"></i>
                        </span>
                        <span class="title">Orders</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-shirt"></i>
                        </span>
                        <span class="title">Products</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-chart-simple"></i>
                        </span>
                        <span class="title">Analytics</span>
                    </a>
                </li>

                <li>
                    <a href="invoice.html">
                        <span class="icon">
                            <i class="fa-solid fa-file-invoice"></i>
                        </span>
                        <span class="title">invoice</span>
                    </a>
                </li>

                <li>
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-gear"></i>
                        </span>
                        <span class="title">Settings</span>
                    </a>
                </li>

                <li onclick="logout()">
                    <a href="#">
                        <span class="icon">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </span>
                        <span class="title">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        
   
<!-- Add this button inside the body tag -->
<div class="order-container">

    <div class="statictics-container">
<div class="container mt-3">
    <div class="card shadow rounded card-hover">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Total Sales</h5>
        </div>
        <div class="card-body">
            <p class="card-text mb-0" id="totalNotificationCount">0</p>
        </div>
    </div>
</div>

<!-- Top Customers Container -->
<div class="container mt-3">
    <div class="card shadow rounded card-hover">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Top Customers</h5>
        </div>
        <div class="card-body" id="topCustomersContainer">
            <!-- Top customers will be dynamically added here -->
        </div>
    </div>
</div>
<!-- Top Products Container -->
<div class="container mt-3">
    <div class="card shadow rounded card-hover">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Top Products</h5>
        </div>
        <div class="card-body" id="topProductsContainer">
            <!-- Top products will be dynamically added here -->
        </div>
    </div>
</div>

</div>







   <div class="button-container">
    <!-- Search Bar -->
<div class="container mt-3">
    <input type="text" class="form-control" id="searchInput" placeholder="Search by day or time">
  </div>
  
  
   <div class="btn-container">
     <button onclick="clearNotifications()" class="btn btn-primary">Clear Notifications</button>
    <button onclick="clearRealtimeDatabase()" class="btn btn-primary">Clear Real-time Database</button></div>
   </div>

    <div><div id="orderDetailsContainer" style="display: none;"></div><div id="qrCodeContainer"></div></div>
    <div id="notificationsContainer"></div>
</div>

<script>
    // Check login state from local storage
    var loggedIn = localStorage.getItem('Aknviauth172vGGh');
    var idn = 'NCPcolomi1v56b';
    
    if (loggedIn !== idn ){
        document.getElementById('body').style.display = 'none';
        window.location.href = 'auth.html';
    }
</script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
                // Initialize Firebase with your configuration
                var firebaseConfig = {
            apiKey: "AIzaSyDkzYyAPXcGoNE1efAuAp5t6YVT3SYhOvg",
            authDomain: "salsabil-order.firebaseapp.com",
            databaseURL: "https://salsabil-order-default-rtdb.firebaseio.com",
            projectId: "salsabil-order",
            storageBucket: "salsabil-order.appspot.com",
            messagingSenderId: "336133726144",
            appId: "1:336133726144:web:be467b085f67ca97657225",
            measurementId: "G-P0561X9RTQ"
};
   
firebase.initializeApp(firebaseConfig);

const database = firebase.database();
const notificationsContainer = document.getElementById('notificationsContainer');
const orderDetailsContainer = document.getElementById('orderDetailsContainer');

// Listen for new orders
database.ref('orders').on('child_added', (snapshot) => {
    const orderData = snapshot.val();
    const orderId = snapshot.key;

    // Display a notification
    displayNotification(orderData, orderId);
    updateTopCustomers(orderData)
    updateTopProducts(orderData)
});

// Update the displayNotification function
// Update the displayNotification function
function displayNotification(orderData, orderId) {
    const notificationDiv = document.createElement('div');
    notificationDiv.className = 'notification';
    notificationDiv.innerHTML = `
        <i class="fa-solid fa-circle-check" style="color: #7da01c;"></i>
        <p id="notify-text">${orderData.name} placed an order on ${orderData.timestamp}</p>
        <button class="btn btn-link text-danger" onclick="removeNotification('${orderId}')" id="removeOrder">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    notificationDiv.addEventListener('click', (event) => {
        // Show order details when the notification is clicked
        if (event.target.closest('.fa-trash')) {
            return;
        }
        else{
        displayOrderDetails(orderData, orderId);}
    });

    // Play the notification sound
    document.getElementById('notificationSound').play();

    // Get the date of the notification
    const notificationDate = new Date(orderData.timestamp);
    
    // Create or find the divider for the notification date
    const dividerId = `divider-${notificationDate.toISOString().slice(0, 10)}`;
    let divider = document.getElementById(dividerId);

    if (!divider) {
        divider = document.createElement('div');
        divider.className = 'notification-divider';
        divider.id = dividerId;
        divider.innerHTML = `<p>${formatDate(notificationDate)}</p>`;
        notificationsContainer.insertBefore(divider, notificationsContainer.firstChild);
    }

    // Insert the new notification under the appropriate divider
    divider.parentNode.insertBefore(notificationDiv, divider.nextSibling);

    updateTotalNotificationCount();
}

// Helper function to format the date as 'Today', 'Yesterday', or 'YYYY-MM-DD'
function formatDate(date) {
    const today = new Date();
    const yesterday = new Date();
    yesterday.setDate(today.getDate() - 1);

    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toISOString().slice(0, 10);
    }
}



function removeNotification(orderId) {
    // Get a reference to the specific order node in the database
    const orderRef = database.ref('orders').child(orderId);

    // Ask for confirmation before proceeding
    const userConfirmed = confirm('Are you sure you want to delete the order?');

    // Check if the user confirmed
    if (userConfirmed) {
        // Check if the orderRef exists
        if (orderRef) {
            // Remove the order from the database
            orderRef.remove()
                .then(() => {
                    // Reload the page after successful removal
                    location.reload();
                    // Update the total notification count (assuming this function exists)
                    updateTotalNotificationCount();
                    // Show a success alert
                    alert('Notification removed successfully!');
                })
                .catch((error) => {
                    // Handle any errors that might occur during the removal
                    console.error('Error removing order:', error);
                    alert('An error occurred while removing the order. Please try again.');
                });
        } else {
            // Show an alert if the order is not found
            alert('Order not found');
        }
    } else {
        // If the user didn't confirm, do nothing
        return;
    }
}


function clearNotifications() {
    notificationsContainer.innerHTML = '';
    updateTotalNotificationCount();
}


// Function to display order details
// Function to display order details
function displayOrderDetails(orderData, orderId) {
    // Clear previous order details
    orderDetailsContainer.innerHTML = '';

    const orderDetailsDiv = document.createElement('div');
    orderDetailsDiv.className = 'orderDetails';
    orderDetailsDiv.innerHTML = `
        <button id="closeButton" onclick="closeOrderDetails()" class="btn btn-danger">Close</button>
        <button id="generateQRButton" class="btn btn-primary"><i class="fa-solid fa-qrcode" style="margin-right: 10px;"></i>Generate QR Code</button>
        <button id="invoice-generator-btn"><i class="fa-solid fa-file-invoice"></i></button>
        <table class="user-info">
            <tbody>
                <tr>
                    <td><strong>Checkout time:</strong></td>
                    <td>${orderData.timestamp}</td>
                </tr>
                <tr>
                    <td><strong>Username:</strong></td>
                    <td>${orderData.name}</td>
                </tr>
                <tr>
                    <td><strong>Address:</strong></td>
                    <td>${orderData.address}</td>
                </tr>
                <tr>
                    <td><strong>Shipping Address:</strong></td>
                    <td>${orderData.shippingAddress}</td>
                </tr>
                <tr>
                    <td><strong>Email:</strong></td>
                    <td>
                        <a href="mailto:${orderData.email}?subject=Sal%20sabil%20order%20invoice&amp;body=Your%20order%20was%20successfully%20placed.%20You%20will%20receive%20your%20order%20at%20your%20shipping%20address.%20Your%20order%20details:%0A${encodeURIComponent(getProductListHTML(orderData.products))}">
                            ${orderData.email}
                        </a>
                    </td>
                </tr>

                <tr>
                    <td><strong>Phone Number:</strong></td>
                    <td>${orderData.number}</td>
                </tr>
                <tr>
                    <td><strong>City:</strong></td>
                    <td>${orderData.citySelect}</td>
                </tr>
                <tr>
                    <td><strong>Total:</strong></td>
                    <td>${orderData.total}</td>
                </tr>
                <tr>
                    <td><strong>Shipping:</strong></td>
                    <td>${orderData.shipping}</td>
                </tr>
                <tr>
                    <td><strong>Grand Total:</strong></td>
                    <td>${orderData.grandTotal}</td>
                </tr>
            </tbody>
        </table>
        <p><strong>Orders</strong></p>
        <ul style="list-style: none;">${getProductListHTML(orderData.products)}</ul>
    `;

    orderDetailsContainer.appendChild(orderDetailsDiv);

    // Show the order details container
    orderDetailsContainer.style.display = 'block';
    window.scrollTo(0, 0);
    document.getElementById('generateQRButton').addEventListener('click', function () {
    generateQRCode(orderData);
});
document.getElementById('invoice-generator-btn').addEventListener('click', function () {
        // Generate and save the invoice details
        generateAndSaveInvoice(orderData);
    });
}



// Function to generate and save invoice details in local storage
function generateAndSaveInvoice(orderData) {
    // Create an object to store invoice details
    const invoiceDetails = {
        name: orderData.name,
        address: orderData.address,
        shippingAddress: orderData.shippingAddress,
        shipping: orderData.shipping,
        total: orderData.total,
        grandTotal: orderData.grandTotal,
        email: orderData.email,
        number: orderData.number,
        timestamp: orderData.timestamp,
        products: orderData.products
    };

    // Convert the object to a JSON string
    const invoiceDetailsJSON = JSON.stringify(invoiceDetails);

    // Save the invoice details in local storage
    localStorage.setItem('invoiceDetails', invoiceDetailsJSON);

    // Display a success alert
    alert('Invoice details saved successfully!');
}
function generateQRCode(orderData) {
    // Create a string containing order details (excluding product images)
    const orderDetailsString = `
        checkout time: ${orderData.timestamp}
        Username: ${orderData.name}
        Address: ${orderData.address}
        Shipping Address: ${orderData.shippingAddress}
        Email: ${orderData.email}
        Phone Number: ${orderData.number}
        City: ${orderData.citySelect}
        Total: ${orderData.total}
        Shipping: ${orderData.shipping}
        Grand Total: ${orderData.grandTotal}
        Orders: ${getProductListText(orderData.products)}
    `;

    // Create a new QR code instance
    const qrcode = new QRCode(document.getElementById('qrCodeContainer'), orderDetailsString);
}

// Function to get product list as a text string
function getProductListText(products) {
    return products.map(product => `${product.productName} - ${product.productPrice}`).join('\n');
}



function getProductListHTML(products) {
    return products.map(product => `<li><img src="${product.productImage}" alt="${product.productName}" class="notificationDetailsImage">  ${product.productName} - ${product.productPrice}</li>`).join('');
}


// Function to get the current date in a readable format

function closeOrderDetails() {
    orderDetailsContainer.style.display = 'none';
}

// Function to clear the real-time database
function clearRealtimeDatabase() {
        if (confirm('Are you sure you want to clear the real-time database?')) {
            // Get a reference to the "orders" node in the database
            var ordersRef = firebase.database().ref('orders');

            // Remove all data from the "orders" node
            ordersRef.remove()
                .then(function () {
                    alert('Real-time database cleared successfully!');
                    updateTotalNotificationCount()
                })
                .catch(function (error) {
                    console.error('Error clearing the real-time database:', error.message);
                });
        }
    }

    // Function to update the total notification count
function updateTotalNotificationCount() {
    const totalNotificationCount = document.querySelectorAll('.notification').length;
    document.getElementById('totalNotificationCount').innerText = totalNotificationCount;
}
 // Initialize an object to store customer notifications and sales
 const customerNotifications = {};
    
    // Function to update top customers based on notifications
    function updateTopCustomers(orderData) {
    const customerName = orderData.name;

    // Update customer notifications count
    customerNotifications[customerName] = (customerNotifications[customerName] || 0) + 1;


    // Get the total sales for each customer (you may need to adjust this based on your data structure)
    const totalSales = customerNotifications[customerName] * orderData.grandTotal;

    // Sort customers by total sales in descending order
    const sortedCustomers = Object.entries(customerNotifications)
        .sort(([, a], [, b]) => b - a)
        .reduce((acc, [name, count]) => ({ ...acc, [name]: count }), {});

    // Display the top customers
    displayTopCustomers(sortedCustomers);
}


    // Function to display top customers
    function displayTopCustomers(customers) {
        const topCustomersContainer = document.getElementById('topCustomersContainer');
        topCustomersContainer.innerHTML = '';

        // Display the top 5 customers
        const numToShow = Math.min(Object.keys(customers).length, 5);
        for (let i = 0; i < numToShow; i++) {
            const customerName = Object.keys(customers)[i];
            const notificationCount = customers[customerName];

            const customerDiv = document.createElement('div');
            customerDiv.innerHTML = `<p>${customerName} - order count : ${notificationCount}</p>`;
            topCustomersContainer.appendChild(customerDiv);
        }
    }
    
    // Initialize an object to store product sales
const productSales = {};

// Function to update top products based on notifications
function updateTopProducts(orderData) {
    orderData.products.forEach(product => {
        const productName = product.productName;

        // Update product sales count
        productSales[productName] = (productSales[productName] || 0) + 1;
    });

    // Sort products by sales count in descending order
    const sortedProducts = Object.entries(productSales)
        .sort(([, a], [, b]) => b - a)
        .reduce((acc, [name, count]) => ({ ...acc, [name]: count }), {});

    // Display the top products
    displayTopProducts(sortedProducts);
}
// Function to display top products
function displayTopProducts(products) {
    const topProductsContainer = document.getElementById('topProductsContainer');
    topProductsContainer.innerHTML = '';

    // Display the top 5 products
    const numToShow = Math.min(Object.keys(products).length, 5);
    for (let i = 0; i < numToShow; i++) {
        const productName = Object.keys(products)[i];
        const salesCount = products[productName];

        const productDiv = document.createElement('div');
        productDiv.innerHTML = `<p>${productName} - sales count: ${salesCount}</p>`;
        topProductsContainer.appendChild(productDiv);
    }
}


    </script>
    <script>
       function logout() {
            // Ask for confirmation
            var confirmLogout = confirm("Are you sure you want to sign out?");
            
            if (confirmLogout) {
                // Show loading spinner
                document.getElementById('loading').style.display = 'block';
                
                // Delay for 5 seconds (5000 milliseconds)
                setTimeout(function() {
                    // Remove the "loggedIn" item from local storage
                    localStorage.removeItem('Aknviauth172vGGh');
                    // Redirect to the login page
                    window.location.href = 'auth.html';
                }, 5000);
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Add an input event listener to the search bar
          document.getElementById('searchInput').addEventListener('input', function() {
            // Get the search querya
            const searchQuery = this.value.toLowerCase();
      
            // Iterate through each notification
            document.querySelectorAll('.notification').forEach(function(notification) {
              // Get the text content of the notification
              const notificationText = notification.textContent.toLowerCase();
      
              // Show or hide the notification based on the search query
              if (notificationText.includes(searchQuery)) {
                notification.style.display = 'flex';
              } else {
                notification.style.display = 'none';
              }
            });
          });
        });
      </script>

      <script>

document.addEventListener('DOMContentLoaded', function () {
    const navigation = document.querySelector('.navigation');
    const toggleButton = document.getElementById('toggleButton');
    // Close navigation if window width is greater than 1500px
    if (window.innerWidth < 1500) {
        navigation.classList.add('active');
    }

    // Add click event listener to the toggle button
    toggleButton.addEventListener('click', function () {
        // Toggle the 'active' class on the navigation element
        navigation.classList.toggle('active');
        navigation.classList.toggle('display-navigation')
    });
});

    
      </script>

      
    
</body>
</html>
